# Comprehensive Handshake Behavior Map

This table documents the entire known sequence of packets in the handshake, from initial connection to the various outcomes we have observed.

| #  | Trigger | Sender | Packet Starts With (Hex) | Our Server Response | Resulting Client Behavior | Hypothesis of Client's State/Action |
|----|---------|--------|---------------------------|----------------------|----------------------------|--------------------------------------|
| 1  | Client starts connecting (`engine.on("connectToServer"...)`) | Client | 19 | Send a slice of the client's packet (packet[4:29]) | The client immediately sends the next packet in the sequence (0f). | **[CONFIRMED]** This is NMT_Connect or NMT_Hello. The client is sending its version and handshake challenge. It is waiting for the server to prove it's a valid endpoint by responding with the correct token. |
| 2  | After Server responds to 19 | Client | 0f | | | **[CONFIRMED]** This is NMT_Login / Challenge Response. The client is now requesting to join the server and is in the `EClientLoginState::LoggingIn` state, waiting for the server's `NMT_Welcome`. |
| 3A | Server responds to 0f | Server | A minimal ACK token (packet[5:19]) with no payload. | STALL: Client waits for a moment, then sends a 1b packet. No immediate error. | **[THEORY]** Incomplete Welcome: The client acknowledges our ACK and the connection remains alive. However, it doesn't receive the required map info. After a timeout, it sends the 1b packet (likely a "are you still there?" or "request player list") as its next logical action. |
| 3B | Server responds to 0f | Server | A structurally malformed packet (e.g., our attempts with `\x02\x02` or an invalid bunch structure). | CRASH: Client immediately sends an 09 packet. The game returns to the start screen. | **[THEORY]** SYNTAX ERROR: The client's low-level parser (3FC0) cannot even understand the basic structure of the packet envelope. It's considered junk mail. The 09 is `NMT_Close`, the formal way the client terminates a corrupted connection. |
| 3C | Server responds to 0f | Server | A structurally valid packet with a logically incorrect payload (e.g., a raw string Jungle_P...). | FALLBACK: Client immediately sends a 21 packet. The game returns to the start screen. | **[THEORY]** SEMANTIC ERROR: The packet envelope is valid (passes 3FC0), but the contents are not the expected `NMT_Welcome` message. The parser, confused but not crashed, invokes a fallback system (`NMT_BeaconJoin` or an RPC), trying to salvage the connection. |
| 4A | Server responds to the stalled client's 1b packet | Server | Any packet (e.g., a copy of the 1b packet) | UNKNOWN / LOOP: The client seems to ignore this and re-enters a loop of sending keep-alive packets, eventually timing out. | **[THEORY]** Dead End: At this point in the handshake, the client is only expecting the `NMT_Welcome` packet. Sending anything else does not satisfy its state requirement, and it does not know how to proceed. |
